<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <input type="file" id="input">
  <button id="upload">上传</button>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const input = document.getElementById('input')
    const upload = document.getElementById('upload')

    upload.addEventListener('click', handleUpload)

    let fileObj = null
    input.addEventListener('change', handleChange)

    function handleChange(e) {
      const file = e.target.files[0]
      fileObj = file
    }
    function handleUpload() {
      if (!fileObj) {
        return
      }
      // 将 fileObj 切片
      const chunkList = createChunk(fileObj)
      console.log(chunkList);
      const chunks = chunkList.map(({file}, index) => {
        return {
          file,
          size: file.size,
          chunkName:`${fileObj.name}-${index}`,
          fileName: fileObj.name,
          index,
        }
      })
      // console.log(chunks);
      // 上传切片
      uploadChunk(chunks)

    }

    // 切片
    function createChunk(file, size = 5*1024*1024) {
      const chunkList = []
      let cur = 0
      while(cur < file.size) {
        chunkList.push({
          file: file.slice(cur, cur + size),

        })
        cur += size
      }
      return chunkList
    }
    
    function uploadChunk(chunks) {
      // 将切片处理成 FormData 格式
      let formChunks = chunks.map(({file, fileName, index, chunkName}) => {
        const formData = new FormData()
        formData.append('file', file)
        formData.append('fileName', fileName)
        formData.append('chunkName', chunkName)
        return {formData, index}
      })
      console.log(formChunks);
      
      // 上传切片
      formChunks.forEach(({formData, index}) => {
        return axios.post('http://localhost:3000/upload', formData)
      })
      Promise.all(formChunks).then(res => {
        // console.log(res);
        // 发送合并请求
        axios.post('http://localhost:3000/merge', {
            fileName: fileObj.name,
            size: 5 * 1024 * 1024
        }).then(res => {
          console.log(res);
        })
      })
    }
 </script>
</body>
</html>